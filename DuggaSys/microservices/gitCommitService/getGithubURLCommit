<?php
// getGithubURLcommits.php

// GitHub API endpoint
$api_url = "https://api.github.com/lenasys/b21youab/lenasys/commits";

// Replace with your GitHub Personal Access Token
$github_token = "YOUR_GITHUB_TOKEN";

// Initialize cURL session
$curlhandle = curl_init($api_url);

// Set cURL options
curl_setopt($curlhandle, CURLOPT_RETURNTRANSFER, true);
curl_setopt($curlhandle, CURLOPT_HTTPHEADER, [
    "User-Agent: PHP Script",
    "Authorization: token $github_token"
]);

// Execute cURL request
$response = curl_exec($curlhandle);

// Check for errors
if (curl_errno($curlhandle)) {
    echo json_encode(["error" => curl_error($curlhandle)]);
    exit;
}

// Close cURL session
curl_close($curlhandle);

// Decode JSON response
$commits = json_decode($response, true);

// Process and return the commits data
$processed_commits = [];
foreach ($commits as $commit) {
    $processed_commits[] = [
        "sha" => $commit["sha"],
        "message" => $commit["commit"]["message"],
        "author" => $commit["commit"]["author"]["name"],
        "date" => $commit["commit"]["author"]["date"]
    ];
}

// Output the processed commits as JSON
header("Content-Type: application/json");
echo json_encode($processed_commits); 

// Check if JSON decoding was successful
if (json_last_error() !== JSON_ERROR_NONE) {
    echo json_encode(["error" => "JSON decoding error: " . json_last_error_msg()]);
    exit;
}

// Check if we received an array of commits
if (!is_array($commits)) {
    echo json_encode(["error" => "Unexpected response format", "response" => $commits]);
    exit;
}

// Process and return the commits data
$processed_commits = [];
foreach ($commits as $commit) {
    if (isset($commit["sha"], $commit["commit"]["message"], $commit["commit"]["author"]["name"], $commit["commit"]["author"]["date"])) {
        $processed_commits[] = [
            "sha" => $commit["sha"],
            "message" => $commit["commit"]["message"],
            "author" => $commit["commit"]["author"]["name"],
            "date" => $commit["commit"]["author"]["date"]
        ];
    }
}

// Output the processed commits as JSON
header("Content-Type: application/json");
echo json_encode($processed_commits);